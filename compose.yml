services:
  kong:
    image: kong:3.9.1
    container_name: encurta-ai-kong
    ports:
      - "8000:8000"
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong-config.yaml
      KONG_PLUGINS: bundled
    volumes:
      - ./kong/kong-config.yaml:/etc/kong/kong-config.yaml
    networks:
      encurta-ai-network:
        ipv4_address: 172.20.0.20

  consul:
    image: hashicorp/consul:1.19
    container_name: encurta-ai-consul
    ports:
      - "8500:8500"
      - "8600:8600/udp"
      - "8502:8502"
    command: >
      consul agent -dev
      -client=0.0.0.0
      -ui
      -config-dir=/consul/config
    volumes:
      - ./consul/config:/consul/config
      - ./consul/policies:/consul/policies
    networks:
      encurta-ai-network:
        ipv4_address: 172.20.0.10
  
  consul-config:
    image: hashicorp/consul:1.19
    container_name: encurta-ai-consul-config-loader
    volumes:
      - ./consul/policies:/policies
    networks:
      encurta-ai-network:
        ipv4_address: 172.20.0.50
    depends_on:
      - consul
    command: >
      sh -c "
        sleep 15 &&
        echo 'Applying Consul configurations...' &&
        consul config write -http-addr=172.20.0.10:8500 /policies/proxy-defaults.hcl &&
        echo 'Configurations applied successfully!'
      "
  
  http-echo:
    image: nginx:alpine
    container_name: encurta-ai-http-echo
    command: >
      sh -c "
        echo 'server { 
          listen 5678; 
          location / { 
            return 500 \"Internal Server Error\"; 
          } 
        }' > /etc/nginx/conf.d/default.conf && 
        nginx -g 'daemon off;'
      "
    networks:
      encurta-ai-network:
        ipv4_address: 172.20.0.30

  http-echo-sidecar:
    build:
      context: ./consul/envoy
      dockerfile: Dockerfile
    container_name: encurta-ai-http-echo-sidecar
    network_mode: "container:encurta-ai-http-echo"
    command: >
      consul connect envoy -sidecar-for http-echo
      -http-addr=172.20.0.10:8500
      -grpc-addr=172.20.0.10:8502
      -admin-bind=127.0.0.1:19000
      -ignore-envoy-compatibility
      -- -l debug
    environment:
      CONSUL_HTTP_ADDR: "172.20.0.10:8500"
      CONSUL_GRPC_ADDR: "172.20.0.10:8502"
    depends_on:
      - http-echo
      - consul
      - consul-config

  node-client:
    build: ./node-client
    container_name: encurta-ai-node-client
    environment:
      - TARGET=http://127.0.0.1:9191
    networks:
      encurta-ai-network:
        ipv4_address: 172.20.0.40
    depends_on:
      - consul
      - consul-config
      - http-echo
      - http-echo-sidecar

  node-client-sidecar:
    build:
      context: ./consul/envoy
      dockerfile: Dockerfile
    container_name: encurta-ai-node-client-sidecar
    network_mode: "container:encurta-ai-node-client"
    command: >
      consul connect envoy -sidecar-for node-client
      -http-addr=172.20.0.10:8500
      -grpc-addr=172.20.0.10:8502
      -admin-bind=127.0.0.1:19000
      -ignore-envoy-compatibility
      -- -l debug
    environment:
      CONSUL_HTTP_ADDR: "172.20.0.10:8500"
      CONSUL_GRPC_ADDR: "172.20.0.10:8502"
    depends_on:
      - node-client
      - consul
      - consul-config

networks:
  encurta-ai-network:
    external: true